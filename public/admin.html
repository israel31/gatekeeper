<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .paid-status { font-weight: 600; }
        .status-paid { color: #10B981; } /* Green */
        .status-unpaid { color: #EF4444; } /* Red */
    </style>
</head>
<body class="min-h-screen">

    <header class="bg-white shadow sticky top-0 z-10">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-900">Admin Dashboard</h1>
            <div class="space-x-4 flex items-center">
                <span id="auth-status" class="text-sm text-gray-500"></span>
                <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-medium py-1 px-3 rounded-lg text-sm transition">
                    Logout
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            
            <!-- Global Controls & Status -->
            <div class="bg-white card rounded-lg p-6 mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                
                <div class="flex items-center space-x-4">
                    <span id="portal-status-icon" class="h-6 w-6 rounded-full bg-gray-400 animate-pulse"></span>
                    <span id="portal-status-text" class="text-lg font-semibold text-gray-700">Loading Portal Status...</span>
                </div>
                
                <button id="toggle-portal-button" class="py-2 px-4 rounded-lg text-white font-medium transition duration-150 ease-in-out w-full md:w-auto" disabled>
                    Toggle Portal
                </button>
                
            </div>
            
            <!-- Filters and Search -->
            <div class="bg-white card rounded-lg p-4 mb-6 flex flex-col sm:flex-row gap-4">
                <input type="text" id="search-input" placeholder="Search by name or email..." class="flex-grow p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                
                <select id="filter-status" class="p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <option value="all">All Entries</option>
                    <option value="paid">Paid Only</option>
                    <option value="unpaid">Unpaid Only</option>
                </select>
                
                <!-- Export Buttons -->
                <div class="flex space-x-2">
                    <button id="export-all-btn" class="bg-gray-700 hover:bg-gray-800 text-white p-2 rounded-lg text-sm transition flex-shrink-0">Export All CSV</button>
                    <button id="export-paid-btn" class="bg-gray-700 hover:bg-gray-800 text-white p-2 rounded-lg text-sm transition flex-shrink-0">Export Paid CSV</button>
                    <button id="export-unpaid-btn" class="bg-gray-700 hover:bg-gray-800 text-white p-2 rounded-lg text-sm transition flex-shrink-0">Export Unpaid CSV</button>
                </div>
            </div>

            <!-- Entries Table -->
            <div class="overflow-x-auto bg-white card rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Answers</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submitted</th>
                        </tr>
                    </thead>
                    <tbody id="entries-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="5" class="text-center py-4 text-gray-500">Loading entries...</td></tr>
                    </tbody>
                </table>
                <div id="no-entries" class="hidden text-center py-8 text-gray-500">No entries found matching the criteria.</div>
            </div>
            
            <!-- Pagination -->
            <div class="flex justify-between items-center mt-4 p-4 bg-white card rounded-lg">
                <button id="prev-page" class="py-2 px-4 bg-gray-200 rounded-lg text-gray-700 font-medium disabled:opacity-50" disabled>Previous</button>
                <span id="page-info" class="text-gray-600">Page 1 of 1</span>
                <button id="next-page" class="py-2 px-4 bg-gray-200 rounded-lg text-gray-700 font-medium disabled:opacity-50" disabled>Next</button>
            </div>
        </div>
    </main>

    <script type="module">
        import { supabase, requireAuth, signOut, showMessage, SUPABASE_URL } from './js/utils.js';

        // --- DOM Elements ---
        const tableBody = document.getElementById('entries-table-body');
        const searchInput = document.getElementById('search-input');
        const filterStatus = document.getElementById('filter-status');
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const pageInfo = document.getElementById('page-info');
        const logoutBtn = document.getElementById('logout-button');
        const authStatusEl = document.getElementById('auth-status');
        const toggleBtn = document.getElementById('toggle-portal-button');
        const statusIcon = document.getElementById('portal-status-icon');
        const statusText = document.getElementById('portal-status-text');
        const exportAllBtn = document.getElementById('export-all-btn');
        const exportPaidBtn = document.getElementById('export-paid-btn');
        const exportUnpaidBtn = document.getElementById('export-unpaid-btn');
        const noEntriesEl = document.getElementById('no-entries');

        // --- State ---
        const ENTRIES_PER_PAGE = 10;
        let currentPage = 0;
        let totalCount = 0;
        let FORM_ID = null;
        let IS_OPEN = null;
        let user = null;

        // --- Utility Functions ---

        // Simple JSON formatting for display
        const formatAnswers = (jsonString) => {
            try {
                const answers = JSON.parse(jsonString);
                return Object.entries(answers).map(([key, value]) => 
                    `<div class="text-xs text-gray-500">${key}: ${value}</div>`
                ).join('');
            } catch (e) {
                return '<span class="text-xs text-red-400">Invalid JSON</span>';
            }
        };

        const renderTable = (entries) => {
            tableBody.innerHTML = '';
            noEntriesEl.classList.add('hidden');

            if (entries.length === 0) {
                noEntriesEl.classList.remove('hidden');
                return;
            }

            entries.forEach(entry => {
                const statusClass = entry.payment_status === 'paid' ? 'status-paid' : 'status-unpaid';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${entry.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${entry.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass} paid-status capitalize">${entry.payment_status}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${formatAnswers(entry.answers)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(entry.created_at).toLocaleDateString()}</td>
                `;
                tableBody.appendChild(row);
            });
        };
        
        const updatePaginationControls = () => {
            const totalPages = Math.ceil(totalCount / ENTRIES_PER_PAGE);
            pageInfo.textContent = `Page ${currentPage + 1} of ${totalPages || 1}`;
            prevBtn.disabled = currentPage === 0;
            nextBtn.disabled = currentPage >= totalPages - 1;
        };

        // --- Data Fetching & Real-Time Listeners ---

        async function fetchEntries() {
            if (!FORM_ID) return;

            const offset = currentPage * ENTRIES_PER_PAGE;
            const filter = filterStatus.value;
            const search = searchInput.value.trim();

            let query = supabase
                .from('entries')
                .select('*', { count: 'exact' }) // Request exact count for pagination
                .order('created_at', { ascending: false })
                .range(offset, offset + ENTRIES_PER_PAGE - 1);

            // Apply filters
            if (filter !== 'all') {
                query = query.eq('payment_status', filter);
            }

            // Apply search
            if (search) {
                // Supabase Full-Text Search is complex, so we'll use simple LIKE filtering
                // NOTE: This relies on Supabase allowing LIKE/ILIKE on RLS policies, which is typical.
                query = query.or(`name.ilike.%${search}%,email.ilike.%${search}%`);
            }

            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Loading entries...</td></tr>';

            const { data, error, count } = await query;

            if (error) {
                console.error('Error fetching entries:', error);
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Failed to load entries.</td></tr>';
                return;
            }

            totalCount = count;
            renderTable(data);
            updatePaginationControls();
        }

        async function fetchFormConfig() {
            const { data, error } = await supabase
                .from('forms')
                .select('id, is_open')
                .limit(1)
                .single();

            if (error || !data) {
                console.error('Error fetching form config:', error);
                toggleBtn.disabled = true;
                statusText.textContent = 'Configuration Error';
                statusIcon.classList.remove('bg-gray-400');
                statusIcon.classList.add('bg-red-500');
                return;
            }

            FORM_ID = data.id;
            IS_OPEN = data.is_open;
            updatePortalStatusUI();
            toggleBtn.disabled = false;
        }

        function updatePortalStatusUI() {
            if (IS_OPEN === true) {
                statusText.textContent = 'Portal is OPEN';
                statusIcon.className = 'h-6 w-6 rounded-full bg-green-500';
                toggleBtn.textContent = 'Close Portal';
                toggleBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                toggleBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            } else if (IS_OPEN === false) {
                statusText.textContent = 'Portal is CLOSED';
                statusIcon.className = 'h-6 w-6 rounded-full bg-red-500';
                toggleBtn.textContent = 'Open Portal';
                toggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                toggleBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            }
        }

        // --- Event Handlers ---
        
        // 1. Portal Toggle
        toggleBtn.addEventListener('click', async () => {
            if (!FORM_ID) return;
            toggleBtn.disabled = true;
            
            const action = IS_OPEN ? 'close' : 'open';
            toggleBtn.textContent = `${action === 'close' ? 'Closing' : 'Opening'}...`;
            
            try {
                // Call Edge Function for toggling
                const edgeFunctionUrl = `${SUPABASE_URL}/functions/v1/toggle-form`;
                const { data: { session } } = await supabase.auth.getSession();

                if (!session) throw new Error("User session expired. Please log out and back in.");

                const response = await fetch(edgeFunctionUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}` // Send user JWT
                    },
                    body: JSON.stringify({ form_id: FORM_ID, is_open: !IS_OPEN })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to toggle portal.');
                }
                
                const result = await response.json();
                IS_OPEN = result.is_open;
                updatePortalStatusUI();
                showMessage('message-area', `Portal successfully set to ${IS_OPEN ? 'OPEN' : 'CLOSED'}.`);

            } catch (error) {
                console.error('Toggle Error:', error);
                showMessage('message-area', `Toggle failed: ${error.message}`, true);
            } finally {
                toggleBtn.disabled = false;
                updatePortalStatusUI(); // Reset button text if error occurred
            }
        });

        // 2. Export CSV
        const handleExport = async (type) => {
            if (!FORM_ID) return;
            
            const btn = document.getElementById(`export-${type}-btn`);
            const originalText = btn.textContent;
            btn.textContent = `Exporting ${type}...`;
            btn.disabled = true;

            try {
                const { data: { session } } = await supabase.auth.getSession();

                if (!session) throw new Error("Authentication required for export.");

                // Call Edge Function for CSV generation
                const edgeFunctionUrl = `${SUPABASE_URL}/functions/v1/export-csv`;
                const response = await fetch(edgeFunctionUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}` // Send user JWT
                    },
                    body: JSON.stringify({ form_id: FORM_ID, type })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'CSV export failed.');
                }

                // The Edge Function returns a CSV file stream (Content-Disposition: attachment)
                // We create a Blob and a temporary link to trigger the download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `entries_${type}_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                showMessage('message-area', `${type.toUpperCase()} entries downloaded successfully.`);

            } catch (error) {
                console.error('Export Error:', error);
                showMessage('message-area', `Export failed: ${error.message}`, true);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        };

        exportAllBtn.addEventListener('click', () => handleExport('all'));
        exportPaidBtn.addEventListener('click', () => handleExport('paid'));
        exportUnpaidBtn.addEventListener('click', () => handleExport('unpaid'));

        // 3. Navigation and Filtering
        prevBtn.addEventListener('click', () => { if (currentPage > 0) { currentPage--; fetchEntries(); } });
        nextBtn.addEventListener('click', () => { currentPage++; fetchEntries(); });
        filterStatus.addEventListener('change', () => { currentPage = 0; fetchEntries(); });
        searchInput.addEventListener('input', () => { currentPage = 0; fetchEntries(); });

        // 4. Logout
        logoutBtn.addEventListener('click', signOut);

        // 5. Real-time updates (Optional, but highly recommended for Admin)
        function subscribeToRealtime() {
            // Listen for changes in the 'entries' table (e.g., payment status updates)
            supabase.channel('public:entries')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'entries' }, (payload) => {
                    console.log('Real-time update received:', payload);
                    // Instead of complex table manipulation, just re-fetch the current page
                    // This covers INSERTs and UPDATEs (payment success)
                    fetchEntries();
                })
                .subscribe();
        }

        // --- Initialization ---
        async function init() {
            user = await requireAuth();
            if (!user) return; // requireAuth handles redirection

            authStatusEl.textContent = `Logged in as: ${user.email}`;

            // Fetch initial configuration (includes FORM_ID)
            await fetchFormConfig();

            // Fetch initial data
            await fetchEntries();

            // Setup real-time listener
            subscribeToRealtime();
        }

        init();
    </script>
</body>
</html>