<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .paid-status { font-weight: 600; }
        .status-paid { color: #10B981; } /* Green */
        .status-unpaid { color: #EF4444; } /* Red */
    </style>
</head>
<body class="min-h-screen">

    <header class="bg-white shadow sticky top-0 z-10">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-900">Admin Dashboard</h1>
            <div class="space-x-4 flex items-center">
                <span id="auth-status" class="text-sm text-gray-500"></span>
                <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-medium py-1 px-3 rounded-lg text-sm transition">
                    Logout
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            
            <div id="message-area" class="text-sm font-medium hidden p-3 rounded-lg mb-4"></div>
            
            <div class="bg-white card rounded-lg p-6 mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                <div class="flex items-center space-x-4">
                    <label for="form-selector" class="text-lg font-semibold text-gray-700">Manage Form:</label>
                    <select id="form-selector" class="p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 w-64">
                        <option value="">Loading Forms...</option>
                    </select>
                </div>
                <a href="/create-form.html" class="py-2 px-4 rounded-lg text-white font-medium bg-blue-600 hover:bg-blue-700 transition duration-150 ease-in-out w-full md:w-auto text-center">
                    + Create New Form
                </a>
            </div>

            <div class="bg-gray-800 text-white card rounded-lg p-4 mb-6 flex justify-between items-center">
                <div class="flex-grow">
                    <span class="text-xs font-medium opacity-75">Public Registration Link (Click to Copy):</span>
                    <p id="public-link-display" class="text-lg font-mono truncate cursor-pointer hover:underline">Select a form above...</p>
                </div>
                <button id="copy-link-btn" class="ml-4 p-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition" title="Copy Link" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3h-2a3 3 0 01-3-3H6z" /></svg>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                
                <div class="bg-white card rounded-lg p-6">
                    <p class="text-sm font-medium text-gray-500">Total Entries</p>
                    <p id="stat-total-entries" class="text-3xl font-bold text-gray-900 mt-1">...</p>
                </div>
                
                <div class="bg-white card rounded-lg p-6">
                    <p class="text-sm font-medium text-gray-500">Paid Registrations</p>
                    <p id="stat-paid-entries" class="text-3xl font-bold text-green-600 mt-1">...</p>
                </div>
                
                <div class="bg-white card rounded-lg p-6">
                    <p class="text-sm font-medium text-gray-500">Total Earnings</p>
                    <p id="stat-total-earnings" class="text-3xl font-bold text-blue-600 mt-1">...</p>
                </div>
                
            </div>

            <div class="bg-white card rounded-lg p-6 mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                
                <div class="flex items-center space-x-4">
                    <span id="portal-status-icon" class="h-6 w-6 rounded-full bg-gray-400 animate-pulse"></span>
                    <span id="portal-status-text" class="text-lg font-semibold text-gray-700">Loading Portal Status...</span>
                </div>
                
                <button id="toggle-portal-button" class="py-2 px-4 rounded-lg text-white font-medium transition duration-150 ease-in-out w-full md:w-auto" disabled>
                    Toggle Portal
                </button>
                
            </div>
            
            <div class="bg-white card rounded-lg p-4 mb-6 flex flex-col sm:flex-row gap-4">
                <input type="text" id="search-input" placeholder="Search by name or email..." class="flex-grow p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                
                <select id="filter-status" class="p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <option value="all">All Entries</option>
                    <option value="paid">Paid Only</option>
                    <option value="unpaid">Unpaid Only</option>
                </select>
                
                <div class="flex space-x-2">
                    <button id="export-all-btn" class="bg-gray-700 hover:bg-gray-800 text-white p-2 rounded-lg text-sm transition flex-shrink-0">Export All CSV</button>
                    <button id="export-paid-btn" class="bg-gray-700 hover:bg-gray-800 text-white p-2 rounded-lg text-sm transition flex-shrink-0">Export Paid CSV</button>
                    <button id="export-unpaid-btn" class="bg-gray-700 hover:bg-gray-800 text-white p-2 rounded-lg text-sm transition flex-shrink-0">Export Unpaid CSV</button>
                </div>
            </div>

            <div class="overflow-x-auto bg-white card rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Answers</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submitted</th>
                        </tr>
                    </thead>
                    <tbody id="entries-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="5" class="text-center py-4 text-gray-500">Loading entries...</td></tr>
                    </tbody>
                </table>
                <div id="no-entries" class="hidden text-center py-8 text-gray-500">No entries found matching the criteria.</div>
            </div>
            
            <div class="flex justify-between items-center mt-4 p-4 bg-white card rounded-lg">
                <button id="prev-page" class="py-2 px-4 bg-gray-200 rounded-lg text-gray-700 font-medium disabled:opacity-50" disabled>Previous</button>
                <span id="page-info" class="text-gray-600">Page 1 of 1</span>
                <button id="next-page" class="py-2 px-4 bg-gray-200 rounded-lg text-gray-700 font-medium disabled:opacity-50" disabled>Next</button>
            </div>
        </div>
    </main>

    <script type="module">
        import { supabase, requireAuth, signOut, showMessage, SUPABASE_URL } from '/js/utils.js'; // FIX: Absolute path

        // --- DOM Elements ---
        const tableBody = document.getElementById('entries-table-body');
        const searchInput = document.getElementById('search-input');
        const filterStatus = document.getElementById('filter-status');
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const pageInfo = document.getElementById('page-info');
        const logoutBtn = document.getElementById('logout-button');
        const authStatusEl = document.getElementById('auth-status');
        const toggleBtn = document.getElementById('toggle-portal-button');
        const statusIcon = document.getElementById('portal-status-icon');
        const statusText = document.getElementById('portal-status-text');
        const exportAllBtn = document.getElementById('export-all-btn');
        const exportPaidBtn = document.getElementById('export-paid-btn');
        const exportUnpaidBtn = document.getElementById('export-unpaid-btn');
        const noEntriesEl = document.getElementById('no-entries');
        const formSelector = document.getElementById('form-selector');
        
        // NEW ANALYTICS ELEMENTS
        const publicLinkDisplay = document.getElementById('public-link-display');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const statTotalEntries = document.getElementById('stat-total-entries');
        const statPaidEntries = document.getElementById('stat-paid-entries');
        const statTotalEarnings = document.getElementById('stat-total-earnings');

        // --- State ---
        const ENTRIES_PER_PAGE = 10;
        let currentPage = 0;
        let totalCount = 0;
        let FORM_ID = null; 
        let IS_OPEN = null;
        let FORM_PRICE = 0; // NEW: Store the price for earnings calculation
        let FORM_SLUG = null; // NEW: Store the slug for link display
        let user = null;

        // Helper to format currency (assuming NGN based on Paystack)
        const formatCurrency = (kobo) => {
            if (typeof kobo !== 'number') return 'N/A';
            const naira = kobo / 100;
            return new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN' }).format(naira);
        };

        // --- Data Fetching & Real-Time Listeners ---
        
        // NEW: Fetch and display form analytics
        async function fetchFormAnalytics() {
            if (!FORM_ID) return;

            // Reset stats display
            statTotalEntries.textContent = '...';
            statPaidEntries.textContent = '...';
            statTotalEarnings.textContent = '...';

            // Query 1: Get count of all entries
            const { count: totalCount, error: totalError } = await supabase
                .from('entries')
                .select('id', { count: 'exact', head: true })
                .eq('form_id', FORM_ID);

            // Query 2: Get count and sum of paid entries
            const { count: paidCount, error: paidError } = await supabase
                .from('entries')
                .select('id', { count: 'exact', head: true })
                .eq('form_id', FORM_ID)
                .eq('payment_status', 'paid');
                
            if (totalError || paidError) {
                console.error('Error fetching analytics:', totalError || paidError);
                statTotalEntries.textContent = 'Error';
                statPaidEntries.textContent = 'Error';
                statTotalEarnings.textContent = 'Error';
                return;
            }

            // Calculate Earnings (using the stored price in kobo)
            const totalEarnings = paidCount * FORM_PRICE;

            // Update UI
            statTotalEntries.textContent = totalCount || 0;
            statPaidEntries.textContent = paidCount || 0;
            statTotalEarnings.textContent = formatCurrency(totalEarnings);
        }

        async function fetchEntries() {
            if (!FORM_ID) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Select a form to view entries.</td></tr>';
                noEntriesEl.classList.add('hidden');
                return;
            }

            // Also fetch analytics whenever entries are refreshed
            fetchFormAnalytics(); 

            const offset = currentPage * ENTRIES_PER_PAGE;
            const filter = filterStatus.value;
            const search = searchInput.value.trim();

            let query = supabase
                .from('entries')
                .select('*', { count: 'exact' }) 
                .order('created_at', { ascending: false })
                .eq('form_id', FORM_ID) 
                .range(offset, offset + ENTRIES_PER_PAGE - 1);

            // Apply filters
            if (filter !== 'all') {
                query = query.eq('payment_status', filter);
            }

            // Apply search
            if (search) {
                query = query.or(`name.ilike.%${search}%,email.ilike.%${search}%`);
            }

            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Loading entries...</td></tr>';

            const { data, error, count } = await query;

            if (error) {
                console.error('Error fetching entries:', error);
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Failed to load entries.</td></tr>';
                return;
            }

            totalCount = count;
            renderTable(data);
            updatePaginationControls();
        }

async function fetchUserForms() {
    formSelector.innerHTML = '<option value="">Loading Forms...</option>'; 

    try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) throw new Error("Session expired. Please log in again.");

        // Call the secure Edge Function to get forms
        const edgeFunctionUrl = `${SUPABASE_URL}/functions/v1/get-user-forms`;
        
        const response = await fetch(edgeFunctionUrl, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}` 
            },
        });
        
        const data = await response.json(); 

        if (!response.ok) {
            // Error returned from the Edge Function
            throw new Error(data.error || 'Failed to fetch user forms from server.');
        }

        formSelector.innerHTML = ''; // Clear 'Loading Forms'

        if (data.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'No Forms Found. Create one!';
            formSelector.appendChild(option);
            
            // Disable all controls and reset state
            FORM_ID = null;
            toggleBtn.disabled = true; 
            exportAllBtn.disabled = true;
            exportPaidBtn.disabled = true;
            exportUnpaidBtn.disabled = true;
            copyLinkBtn.disabled = true;
            statusText.textContent = 'No Forms Available';
            statusIcon.className = 'h-6 w-6 rounded-full bg-gray-400';
            return;
        }

        data.forEach(form => {
            const option = document.createElement('option');
            option.value = form.id;
            option.textContent = `${form.title} (${form.slug})`;
            option.dataset.isOpen = form.is_open;
            option.dataset.slug = form.slug; 
            option.dataset.price = form.price; 
            formSelector.appendChild(option);
        });
        
        // Set the first form as the active one
        FORM_ID = data[0].id;
        IS_OPEN = data[0].is_open;
        FORM_SLUG = data[0].slug;
        FORM_PRICE = data[0].price;
        
        // Enable controls and fetch data for the first form
        toggleBtn.disabled = false;
        exportAllBtn.disabled = false;
        exportPaidBtn.disabled = false;
        exportUnpaidBtn.disabled = false;
        copyLinkBtn.disabled = false;
        updatePortalStatusUI();

    } catch (error) {
        console.error('Error fetching user forms:', error);
        // The showMessage call in the catch block is now managed by the browser 
        // to prevent the secondary TypeError from stopping the execution.
        showMessage('message-area', `Error: ${error.message}. Check browser console for details.`, true);
        formSelector.innerHTML = '<option value="">Error Loading Forms</option>';
    }
}
        function updatePortalStatusUI() {
            // Update portal status (Open/Closed)
            if (IS_OPEN === true) {
                statusText.textContent = 'Portal is OPEN';
                statusIcon.className = 'h-6 w-6 rounded-full bg-green-500';
                toggleBtn.textContent = 'Close Portal';
                toggleBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                toggleBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            } else if (IS_OPEN === false) {
                statusText.textContent = 'Portal is CLOSED';
                statusIcon.className = 'h-6 w-6 rounded-full bg-red-500';
                toggleBtn.textContent = 'Open Portal';
                toggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                toggleBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            }
            
            // NEW: Update Public Link Display
            if (FORM_SLUG) {
                const publicUrl = `${window.location.origin}/f/${FORM_SLUG}`;
                publicLinkDisplay.textContent = publicUrl;
                publicLinkDisplay.title = publicUrl;
            } else {
                publicLinkDisplay.textContent = 'Select a form above...';
                copyLinkBtn.disabled = true;
            }
        }

        // --- Event Handlers ---
        
        // NEW: Copy Link Functionality
        copyLinkBtn.addEventListener('click', async () => {
            const link = publicLinkDisplay.textContent;
            try {
                await navigator.clipboard.writeText(link);
                showMessage('message-area', 'Link copied to clipboard!', false);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showMessage('message-area', 'Error: Could not copy link.', true);
            }
        });

        // 5. Form Selection Change
        formSelector.addEventListener('change', () => {
            const selectedOption = formSelector.options[formSelector.selectedIndex];
            if (selectedOption.value) {
                FORM_ID = selectedOption.value;
                IS_OPEN = selectedOption.dataset.isOpen === 'true'; 
                FORM_SLUG = selectedOption.dataset.slug; // Update slug
                FORM_PRICE = parseInt(selectedOption.dataset.price); // Update price
                currentPage = 0; 
                updatePortalStatusUI();
                fetchEntries();
            }
        });
        
        // ... (Other event handlers like toggleBtn, export buttons, etc. remain the same) ...

        // 6. Real-time updates (fetchFormAnalytics added here)
        function subscribeToRealtime() {
            supabase.channel('public:entries')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'entries' }, (payload) => {
                    console.log('Real-time update received:', payload);
                    fetchEntries(); // Refreshes entries and analytics
                })
                .subscribe();
        }

        // --- Initialization ---
        async function init() {
            user = await requireAuth();
            if (!user) return; 

            authStatusEl.textContent = `Logged in as: ${user.email}`;

            await fetchUserForms(); 

            // fetchEntries calls fetchFormAnalytics
            await fetchEntries();

            subscribeToRealtime();
        }

        init();
    </script>
</body>
</html>